<script>
const imageFolder = "pure_symbols/";

// шаг 1: загрузим список файлов из каталога (через fetch directory listing GitHub/локально)
async function fetchImageList() {
    const response = await fetch(imageFolder);
    const text = await response.text();

    // извлечём имена файлов
    const files = [...text.matchAll(/>([^<]+?\.(png|jpg|jpeg|svg|webp))</gi)].map(m => m[1]);
    return files;
}

// шаг 2: найти картинки по номеру в имени
function findImagesByNumber(files, number) {
    // ищем любое вхождение _n / -n / n_
    const regex = new RegExp(`[^0-9]${number}[^0-9]`);
    return files.filter(f => regex.test(f));
}

// шаг 3: создать миниатюры
function renderThumbnails(cell, images) {
    cell.innerHTML = "";
    if (images.length === 0) {
        cell.innerHTML = `<div class="image-placeholder">нет файла</div>`;
        return;
    }

    images.forEach(img => {
        const thumb = document.createElement("img");
        thumb.src = `${imageFolder}${img}`;
        thumb.className = "symbol-image";
        thumb.style.margin = "2px";
        thumb.addEventListener("click", () => openGallery(images, img));
        cell.appendChild(thumb);
    });
}

// шаг 4: lightbox галерея
function openGallery(images, current) {
    const overlay = document.createElement("div");
    overlay.style.cssText = `
        position: fixed; top: 0; left: 0;
        width: 100%; height: 100%;
        background: rgba(0,0,0,0.9);
        display: flex; align-items: center; justify-content: center;
        z-index: 9999;
    `;

    const img = document.createElement("img");
    img.src = `${imageFolder}${current}`;
    img.style.maxWidth = "90%";
    img.style.maxHeight = "90%";
    overlay.appendChild(img);

    overlay.addEventListener("click", () => overlay.remove());
    document.body.appendChild(overlay);
}

// шаг 5: главный процесс
async function init() {
    const files = await fetchImageList();
    const usedFiles = new Set();

    document.querySelectorAll("td.symbol-number").forEach(td => {
        const number = parseInt(td.textContent.trim());
        const resultCell = td.parentElement.querySelector(".result-cell");

        const matched = findImagesByNumber(files, number);
        matched.forEach(f => usedFiles.add(f));

        renderThumbnails(resultCell, matched);
    });

    // список нераспознанных
    const orphan = files.filter(f => !usedFiles.has(f));
    if (orphan.length) {
        const orphansBlock = document.createElement("div");
        orphansBlock.style.margin = "30px 0";
        orphansBlock.innerHTML = `
            <h2>Нераспределённые изображения:</h2>
            <p>${orphan.join("<br>")}</p>
        `;
        document.querySelector(".container").appendChild(orphansBlock);
    }
}

init();
</script>
